<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MedAI Fluency Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: 'Roboto', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white shadow">
      <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
        <div>
          <h1 class="text-xl md:text-2xl font-semibold tracking-tight">MedAI Fluency Studio</h1>
          <p class="text-sm text-slate-600">
            A guided quiz based assessment that uses your answers to build a MedAI fluency map across five key competencies.
          </p>
        </div>
        <a href="index.html" class="text-sm text-blue-600 hover:underline">
          Back to MedAI Lexicon
        </a>
      </div>
    </header>

    <!-- Main content -->
    <main class="flex-1">
      <div class="max-w-6xl mx-auto px-4 py-6 md:py-8 space-y-6">

        <!-- Step indicator -->
        <section class="bg-white rounded-lg shadow-sm p-4 md:p-5">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 class="text-base md:text-lg font-semibold text-slate-900">Steps</h2>
              <p class="text-xs md:text-sm text-slate-600">
                Move through the steps, answer the quiz questions, then view your MedAI fluency map and learning path.
              </p>
            </div>
            <div class="flex-1">
              <ol class="flex items-center justify-between text-xs md:text-sm">
                <li class="flex-1 flex items-center step-indicator" data-step="1">
                  <span class="flex items-center justify-center w-6 h-6 rounded-full border border-blue-600 bg-blue-600 text-white text-xs font-semibold mr-2">1</span>
                  <span class="hidden sm:inline text-slate-800">Intro</span>
                  <div class="flex-1 h-px bg-slate-200 ml-2 sm:ml-3"></div>
                </li>
                <li class="flex-1 flex items-center step-indicator" data-step="2">
                  <span class="flex items-center justify-center w-6 h-6 rounded-full border border-slate-300 bg-white text-slate-500 text-xs font-semibold mr-2">2</span>
                  <span class="hidden sm:inline text-slate-500">Prompt and technical quiz</span>
                  <div class="flex-1 h-px bg-slate-200 ml-2 sm:ml-3"></div>
                </li>
                <li class="flex-1 flex items-center step-indicator" data-step="3">
                  <span class="flex items-center justify-center w-6 h-6 rounded-full border border-slate-300 bg-white text-slate-500 text-xs font-semibold mr-2">3</span>
                  <span class="hidden sm:inline text-slate-500">Practical and critical quiz</span>
                  <div class="flex-1 h-px bg-slate-200 ml-2 sm:ml-3"></div>
                </li>
                <li class="flex items-center step-indicator" data-step="4">
                  <span class="flex items-center justify-center w-6 h-6 rounded-full border border-slate-300 bg-white text-slate-500 text-xs font-semibold mr-2">4</span>
                  <span class="hidden sm:inline text-slate-500">Workflow quiz and results</span>
                </li>
              </ol>
            </div>
          </div>
        </section>

        <!-- Layout: left wizard, right chart -->
        <section class="grid lg:grid-cols-2 gap-6 items-start">
          <!-- Left: steps -->
          <div class="space-y-4">

            <!-- Step 1: Intro -->
            <section class="step-panel bg-white rounded-lg shadow-sm p-5 md:p-6 space-y-3" data-step="1">
              <h3 class="text-base md:text-lg font-semibold text-slate-900">Step 1 - Orientation</h3>
              <p class="text-sm text-slate-700">
                This Studio uses a bank of MedAI questions to estimate your fluency across five competencies that matter for teaching, research, clinical documentation, and program leadership.
              </p>
              <ul class="text-sm text-slate-700 list-disc pl-5 space-y-1">
                <li>Prompt mastery and conversation patterns</li>
                <li>Model fundamentals and limitations</li>
                <li>Practical use cases in education, research, and clinical work</li>
                <li>Critical evaluation, bias, and safety</li>
                <li>Workflow design and governance</li>
              </ul>
              <p class="text-xs text-slate-600">
                The quiz selects a subset of questions from the MedAI Question Bank each time you visit. It is not a high stakes exam. Use it as a structured way to see where you are solid and where you might want to grow.
              </p>
              <p class="text-xs text-slate-600">
                There are 25 questions in total, 5 from each competency. You will see immediate feedback for each question and a radar chart at the end.
              </p>
              <div class="flex justify-end pt-2">
                <button
                  class="next-step inline-flex items-center px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 active:bg-blue-800"
                  data-next="2"
                >
                  Start quiz - prompt and technical
                </button>
              </div>
            </section>

            <!-- Step 2: Prompt + Technical (quiz based) -->
            <section class="step-panel bg-white rounded-lg shadow-sm p-5 md:p-6 space-y-4 hidden" data-step="2">
              <div class="flex flex-col gap-2">
                <div class="flex justify-between items-start gap-4">
                  <div>
                    <h3 class="text-base md:text-lg font-semibold text-slate-900">Step 2 - Prompt mastery and model fundamentals</h3>
                    <p class="text-xs text-slate-600">
                      This section uses knowledge questions on prompting and core model concepts. Each question gives instant feedback.
                    </p>
                  </div>
                </div>
                <div class="flex flex-wrap gap-2 text-xs">
                  <a
                    href="index.html#prompting-and-conversation"
                    class="inline-flex text-blue-600 hover:underline"
                    target="_blank" rel="noopener"
                  >
                    Prompt related Lexicon terms
                  </a>
                  <span class="text-slate-400">•</span>
                  <a
                    href="index.html#model-fundamentals"
                    class="inline-flex text-blue-600 hover:underline"
                    target="_blank" rel="noopener"
                  >
                    Model fundamentals Lexicon terms
                  </a>
                </div>
              </div>

              <!-- Prompt questions container -->
              <div class="space-y-3 pt-2 border-t border-slate-100">
                <h4 class="text-sm font-semibold text-slate-900">Prompt mastery and conversation patterns</h4>
                <p class="text-xs text-slate-600 mb-1">
                  Five questions are drawn from the MedAI Question Bank for this domain.
                </p>
                <div id="promptQuestionsContainer" class="space-y-3"></div>
              </div>

              <!-- Technical questions container -->
              <div class="space-y-3 pt-3 border-t border-slate-100">
                <h4 class="text-sm font-semibold text-slate-900">Model fundamentals and limitations</h4>
                <p class="text-xs text-slate-600 mb-1">
                  Five questions are drawn from the MedAI Question Bank for this domain.
                </p>
                <div id="technicalQuestionsContainer" class="space-y-3"></div>
              </div>

              <div class="flex justify-between pt-3">
                <button
                  class="prev-step inline-flex items-center px-3 py-2 rounded-md border border-slate-300 text-slate-700 text-sm hover:bg-slate-50"
                  data-prev="1"
                >
                  Back
                </button>
                <button
                  class="next-step inline-flex items-center px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 active:bg-blue-800"
                  data-next="3"
                >
                  Next, practical and critical quiz
                </button>
              </div>
            </section>

            <!-- Step 3: Practical + Critical (quiz based) -->
            <section class="step-panel bg-white rounded-lg shadow-sm p-5 md:p-6 space-y-4 hidden" data-step="3">
              <div class="flex flex-col gap-2">
                <div class="flex justify-between items-start gap-4">
                  <div>
                    <h3 class="text-base md:text-lg font-semibold text-slate-900">Step 3 - Practical use and critical evaluation</h3>
                    <p class="text-xs text-slate-600">
                      These questions focus on how AI can be used in real educational, research, and clinical tasks, and how to evaluate outputs for safety and bias.
                    </p>
                  </div>
                </div>
                <div class="flex flex-wrap gap-2 text-xs">
                  <a
                    href="index.html#practical-use-cases"
                    class="inline-flex text-blue-600 hover:underline"
                    target="_blank" rel="noopener"
                  >
                    Practical use Lexicon terms
                  </a>
                  <span class="text-slate-400">•</span>
                  <a
                    href="index.html#evaluation-and-safety"
                    class="inline-flex text-blue-600 hover:underline"
                    target="_blank" rel="noopener"
                  >
                    Evaluation, bias, and safety terms
                  </a>
                </div>
              </div>

              <!-- Practical questions container -->
              <div class="space-y-3 pt-2 border-t border-slate-100">
                <h4 class="text-sm font-semibold text-slate-900">Practical use cases in education, research, and clinical work</h4>
                <p class="text-xs text-slate-600 mb-1">
                  Five questions are drawn from the MedAI Question Bank for this domain.
                </p>
                <div id="practicalQuestionsContainer" class="space-y-3"></div>
              </div>

              <!-- Critical questions container -->
              <div class="space-y-3 pt-3 border-t border-slate-100">
                <h4 class="text-sm font-semibold text-slate-900">Critical evaluation, bias, and safety</h4>
                <p class="text-xs text-slate-600 mb-1">
                  Five questions are drawn from the MedAI Question Bank for this domain.
                </p>
                <div id="criticalQuestionsContainer" class="space-y-3"></div>
              </div>

              <div class="flex justify-between pt-3">
                <button
                  class="prev-step inline-flex items-center px-3 py-2 rounded-md border border-slate-300 text-slate-700 text-sm hover:bg-slate-50"
                  data-prev="2"
                >
                  Back
                </button>
                <button
                  class="next-step inline-flex items-center px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 active:bg-blue-800"
                  data-next="4"
                >
                  Next, workflow quiz and results
                </button>
              </div>
            </section>

            <!-- Step 4: Workflow + Results trigger (quiz based) -->
            <section class="step-panel bg-white rounded-lg shadow-sm p-5 md:p-6 space-y-4 hidden" data-step="4">
              <div class="flex flex-col gap-2">
                <div class="flex justify-between items-start gap-4">
                  <div>
                    <h3 class="text-base md:text-lg font-semibold text-slate-900">Step 4 - Workflow design and fluency map</h3>
                    <p class="text-xs text-slate-600">
                      These questions focus on how you design AI supported workflows, governance, and human in the loop oversight.
                    </p>
                  </div>
                </div>
                <div class="flex flex-wrap gap-2 text-xs">
                  <a
                    href="index.html#workflow-and-governance"
                    class="inline-flex text-blue-600 hover:underline"
                    target="_blank" rel="noopener"
                  >
                    Workflow and governance Lexicon terms
                  </a>
                </div>
              </div>

              <!-- Workflow questions container -->
              <div class="space-y-3 pt-2 border-t border-slate-100">
                <h4 class="text-sm font-semibold text-slate-900">Workflow design and governance</h4>
                <p class="text-xs text-slate-600 mb-1">
                  Five questions are drawn from the MedAI Question Bank for this domain.
                </p>
                <div id="workflowQuestionsContainer" class="space-y-3"></div>
              </div>

              <div class="flex justify-between pt-3">
                <button
                  class="prev-step inline-flex items-center px-3 py-2 rounded-md border border-slate-300 text-slate-700 text-sm hover:bg-slate-50"
                  data-prev="3"
                >
                  Back
                </button>
                <button
                  id="calculateBtn"
                  class="inline-flex items-center px-4 py-2 rounded-md bg-emerald-600 text-white text-sm font-medium hover:bg-emerald-700 active:bg-emerald-800"
                >
                  See my fluency map and learning path
                </button>
              </div>
            </section>
          </div>

          <!-- Right: chart and summary -->
          <div class="space-y-4">
            <!-- Chart card -->
            <section class="bg-white rounded-lg shadow-sm p-5 md:p-6 space-y-3">
              <h3 class="text-base md:text-lg font-semibold text-slate-900">
                MedAI fluency map
              </h3>
              <p class="text-xs md:text-sm text-slate-600">
                The radar chart will show quiz based scores for five competencies. Complete all questions, then click the button in Step 4 to update your map.
              </p>
              <div class="bg-slate-50 rounded-md p-3">
                <canvas id="fluencyChart" width="400" height="400"></canvas>
              </div>
            </section>

            <!-- Summary card -->
            <section class="bg-white rounded-lg shadow-sm p-5 md:p-6 space-y-3">
              <h3 class="text-base md:text-lg font-semibold text-slate-900">
                Summary and personalized path
              </h3>
              <div id="summarySection" class="space-y-2 text-sm text-slate-800">
                <p class="text-xs text-slate-600">
                  After you complete the quiz and generate your map, this section will summarize your strengths, growth areas, and a practical learning path using the MedAI Lexicon.
                </p>
              </div>
            </section>
          </div>
        </section>

        <!-- For department chairs and program leaders -->
        <section class="bg-white rounded-lg shadow-sm p-5 md:p-6 space-y-3">
          <h3 class="text-base md:text-lg font-semibold text-slate-900">
            For department chairs and program leaders
          </h3>
          <p class="text-sm text-slate-700">
            MedAI Fluency Studio is designed as a low friction tool you can use in faculty development, retreats, and CQI conversations about AI in education, research, and clinical work.
          </p>
          <ul class="text-sm text-slate-700 list-disc pl-5 space-y-1">
            <li>
              <span class="font-medium">Prework for retreats or workshops.</span>
              Ask faculty to complete the Studio in advance, bring a screenshot of their fluency map, and mark one competency they want to grow in the coming year.
            </li>
            <li>
              <span class="font-medium">Small group discussion starter.</span>
              In curriculum committees, clerkship groups, or research teams, invite participants to compare their maps in pairs and name one shared opportunity for the group.
            </li>
            <li>
              <span class="font-medium">Strategic planning input.</span>
              Without collecting individual data, you can use the five categories to frame needs assessment, identify priority use cases, and align MedAI efforts with departmental goals.
            </li>
          </ul>
          <p class="text-xs text-slate-600">
            The Studio does not store responses or transmit data from this page. If you wish to collect aggregate information in the future, you can pair it with a separate anonymous survey.
          </p>
        </section>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-slate-100 border-t">
      <div class="max-w-6xl mx-auto px-4 py-3 text-xs text-slate-500 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
        <span>MedAI Lexicon, LSU Health Sciences Center New Orleans</span>
        <span>Educational quiz and reflection tool, not a clinical decision support system.</span>
      </div>
    </footer>
  </div>

  <!-- Script: step logic, quiz loading, scoring, chart, and summary -->
  <script>
    // Step navigation
    let currentStep = 1;

    function updateStepDisplay() {
      document.querySelectorAll('.step-panel').forEach(panel => {
        const step = Number(panel.dataset.step);
        panel.classList.toggle('hidden', step !== currentStep);
      });

      document.querySelectorAll('.step-indicator').forEach(indicator => {
        const step = Number(indicator.dataset.step);
        const circle = indicator.querySelector('span');
        const label = indicator.querySelector('span:nth-child(2)');

        if (!circle) return;

        if (step === currentStep) {
          circle.classList.remove('bg-white', 'text-slate-500', 'border-slate-300');
          circle.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
          if (label) {
            label.classList.remove('text-slate-500');
            label.classList.add('text-slate-900');
          }
        } else if (step < currentStep) {
          circle.classList.remove('bg-white', 'text-slate-500', 'border-slate-300', 'bg-blue-600', 'border-blue-600');
          circle.classList.add('bg-emerald-600', 'text-white', 'border-emerald-600');
          if (label) {
            label.classList.remove('text-slate-500');
            label.classList.add('text-slate-800');
          }
        } else {
          circle.classList.remove('bg-blue-600', 'bg-emerald-600', 'text-white', 'border-blue-600', 'border-emerald-600');
          circle.classList.add('bg-white', 'text-slate-500', 'border-slate-300');
          if (label) {
            label.classList.remove('text-slate-800', 'text-slate-900');
            label.classList.add('text-slate-500');
          }
        }
      });
    }

    document.querySelectorAll('.next-step').forEach(btn => {
      btn.addEventListener('click', () => {
        const next = Number(btn.dataset.next);
        currentStep = next;
        updateStepDisplay();
      });
    });

    document.querySelectorAll('.prev-step').forEach(btn => {
      btn.addEventListener('click', () => {
        const prev = Number(btn.dataset.prev);
        currentStep = prev;
        updateStepDisplay();
      });
    });

    updateStepDisplay();

    // Chart setup
    const ctx = document.getElementById('fluencyChart').getContext('2d');

    const chartConfig = {
      type: 'radar',
      data: {
        labels: [
          'Prompt mastery',
          'Technical understanding',
          'Practical application',
          'Critical evaluation',
          'Workflow design'
        ],
        datasets: [
          {
            label: 'Your MedAI fluency',
            data: [0, 0, 0, 0, 0],
            fill: true,
            backgroundColor: 'rgba(37, 99, 235, 0.18)',
            borderColor: 'rgba(37, 99, 235, 1)',
            pointBackgroundColor: 'rgba(37, 99, 235, 1)',
            pointBorderColor: '#ffffff',
            pointRadius: 4,
            pointHoverRadius: 5,
            borderWidth: 2
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          r: {
            suggestedMin: 0,
            suggestedMax: 10,
            ticks: {
              stepSize: 2
            },
            angleLines: {
              color: 'rgba(148, 163, 184, 0.4)'
            },
            grid: {
              color: 'rgba(148, 163, 184, 0.4)'
            },
            pointLabels: {
              font: {
                size: 11
              }
            }
          }
        },
        plugins: {
          legend: {
            display: false
          }
        }
      }
    };

    const fluencyChart = new Chart(ctx, chartConfig);

    // Domain configuration
    const DOMAIN_CONFIG = {
      'Prompt mastery and conversation patterns': {
        key: 'prompt',
        label: 'Prompt mastery',
        containerId: 'promptQuestionsContainer'
      },
      'Model fundamentals and limitations': {
        key: 'technical',
        label: 'Technical understanding',
        containerId: 'technicalQuestionsContainer'
      },
      'Practical use cases in education, research, and clinical work': {
        key: 'practical',
        label: 'Practical application ability',
        containerId: 'practicalQuestionsContainer'
      },
      'Critical evaluation, bias, and safety': {
        key: 'critical',
        label: 'Critical evaluation ability',
        containerId: 'criticalQuestionsContainer'
      },
      'Workflow design and governance': {
        key: 'workflow',
        label: 'Workflow design ability',
        containerId: 'workflowQuestionsContainer'
      }
    };

    // Store question metadata and responses
    const questionMeta = {}; // questionId -> { domainKey, correctOption, correctText, isCorrect }
    const questionsByDomain = {
      prompt: [],
      technical: [],
      practical: [],
      critical: [],
      workflow: []
    };

    // Utility: shuffle array (Fisher-Yates)
    function shuffle(array) {
      const arr = array.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // Helper: get question text from any reasonable field name
    function getQuestionText(q) {
      const candidates = ['question', 'Question', 'stem', 'Stem', 'prompt', 'Prompt', 'item', 'Item'];
      for (const key of candidates) {
        if (q.hasOwnProperty(key) && q[key] != null) {
          const val = String(q[key]).trim();
          if (val !== '') return val;
        }
      }
      // fallback: try first non-domain/answer key
      const keys = Object.keys(q);
      for (const key of keys) {
        if (/domain/i.test(key)) continue;
        if (/correct/i.test(key)) continue;
        if (/explanation/i.test(key)) continue;
        if (q[key] != null) {
          const val = String(q[key]).trim();
          if (val !== '') return val;
        }
      }
      return '(no question text found)';
    }

    // Helper: get list of option fields and texts from arbitrary column names
    function getOptionsFromQuestion(q) {
      const keys = Object.keys(q);
      const optionCandidates = [];

      keys.forEach(key => {
        const lower = key.toLowerCase();
        // Skip non-option fields
        if (lower.includes('domain')) return;
        if (lower === 'question' || lower === 'prompt' || lower === 'stem' || lower === 'item') return;
        if (lower.includes('correct') || lower.includes('answerkey') || lower.includes('answer_key')) return;
        if (lower.includes('explanation')) return;

        const val = q[key];
        if (val == null) return;
        const text = String(val).trim();
        if (text === '') return;

        optionCandidates.push({ key, text });
      });

      // Sort keys alphabetically for a stable order, then map to A/B/C/D…
      optionCandidates.sort((a, b) => a.key.localeCompare(b.key));

      const letters = ['A', 'B', 'C', 'D', 'E', 'F'];
      const options = optionCandidates.slice(0, letters.length).map((opt, idx) => ({
        letter: letters[idx],
        text: opt.text,
        sourceKey: opt.key
      }));

      return options;
    }

    // Helper: find correct option letter
    function detectCorrectLetter(q, options) {
      if (options.length === 0) return '';

      const correctFieldCandidates = [
        'correct_option',
        'CorrectOption',
        'Correct_Option',
        'correctOption',
        'correct',
        'Correct',
        'answer',
        'Answer',
        'AnswerKey',
        'Answer Key',
        'answer_key',
        'right_answer',
        'RightAnswer'
      ];

      // 1) Try reading a stored letter
      for (const key of correctFieldCandidates) {
        if (q.hasOwnProperty(key) && q[key] != null) {
          const raw = String(q[key]).trim();
          const asLetter = raw.toUpperCase();
          if (options.some(o => o.letter === asLetter)) {
            return asLetter;
          }
        }
      }

      // 2) Try matching stored correct text to an option text
      for (const key of correctFieldCandidates) {
        if (q.hasOwnProperty(key) && q[key] != null) {
          const raw = String(q[key]).trim().toLowerCase();
          if (raw === '') continue;
          const match = options.find(o => o.text.trim().toLowerCase() === raw);
          if (match) return match.letter;
        }
      }

      // 3) Fallback: default to first option (so quiz still works, even if key missing)
      return options[0].letter;
    }

    // Build one quiz card
    function buildQuestionCard(questionObj, uniqueId, domainKey, options) {
      const card = document.createElement('div');
      card.className = 'question border border-slate-200 rounded-md p-3';
      card.dataset.questionId = uniqueId;
      card.dataset.domainKey = domainKey;

      const stem = document.createElement('p');
      stem.className = 'text-sm font-medium text-slate-800 mb-2';
      stem.textContent = getQuestionText(questionObj);
      card.appendChild(stem);

      const optionsWrapper = document.createElement('div');
      optionsWrapper.className = 'space-y-1 text-sm text-slate-700';

      if (options.length === 0) {
        const warn = document.createElement('p');
        warn.className = 'text-xs text-red-700';
        warn.textContent = 'No options found for this question in the JSON.';
        optionsWrapper.appendChild(warn);
      } else {
        options.forEach(opt => {
          const label = document.createElement('label');
          label.className = 'flex items-start gap-2 option-row';
          label.dataset.optionKey = opt.letter;

          const input = document.createElement('input');
          input.type = 'radio';
          input.name = 'q_' + uniqueId;
          input.value = opt.letter;
          input.className = 'mt-1';

          const span = document.createElement('span');
          span.innerHTML = '<span class="font-semibold mr-1">' + opt.letter + '.</span>' + opt.text;

          label.appendChild(input);
          label.appendChild(span);
          optionsWrapper.appendChild(label);
        });
      }

      card.appendChild(optionsWrapper);

      const feedback = document.createElement('p');
      feedback.className = 'mt-2 text-xs feedback-message';
      card.appendChild(feedback);

      // Attach event listeners
      card.querySelectorAll('input[type="radio"]').forEach(input => {
        input.addEventListener('change', () => {
          handleAnswerSelection(card, input.value);
        });
      });

      return card;
    }

    function clearOptionStyles(cardEl) {
      cardEl.querySelectorAll('.option-row').forEach(row => {
        row.classList.remove('bg-green-50', 'bg-red-50');
        const span = row.querySelector('span');
        if (span) {
          span.classList.remove('text-green-700', 'text-red-700');
        }
      });
    }

    function handleAnswerSelection(cardEl, selectedOption) {
      const questionId = cardEl.dataset.questionId;
      const meta = questionMeta[questionId];
      if (!meta) return;

      clearOptionStyles(cardEl);

      const feedbackEl = cardEl.querySelector('.feedback-message');
      const correctOption = meta.correctOption;
      const correctText = meta.correctText || '';

      const correctRow = cardEl.querySelector('.option-row[data-option-key="' + correctOption + '"]');
      const selectedRow = cardEl.querySelector('.option-row input[value="' + selectedOption + '"]')?.closest('.option-row') || null;

      if (selectedOption === correctOption) {
        meta.isCorrect = true;
        if (correctRow) {
          correctRow.classList.add('bg-green-50');
          const span = correctRow.querySelector('span');
          if (span) span.classList.add('text-green-700');
        }
        feedbackEl.textContent = 'Correct.';
        feedbackEl.className = 'mt-2 text-xs feedback-message text-green-700';
      } else {
        meta.isCorrect = false;
        if (selectedRow) {
          selectedRow.classList.add('bg-red-50');
          const spanSel = selectedRow.querySelector('span');
          if (spanSel) spanSel.classList.add('text-red-700');
        }
        if (correctRow) {
          correctRow.classList.add('bg-red-50');
          const spanCor = correctRow.querySelector('span');
          if (spanCor) spanCor.classList.add('text-red-700');
        }
        feedbackEl.textContent = 'Incorrect. Correct answer: ' + correctOption + '. ' + correctText;
        feedbackEl.className = 'mt-2 text-xs feedback-message text-red-700';
      }
    }

    // Load questions from JSON and populate the quiz
    function initializeQuiz(allQuestions) {
      // Clear any previous recordings (in case of hot reload)
      Object.keys(questionsByDomain).forEach(k => { questionsByDomain[k] = []; });
      Object.keys(questionMeta).forEach(k => { delete questionMeta[k]; });

      Object.keys(DOMAIN_CONFIG).forEach(domainName => {
        const cfg = DOMAIN_CONFIG[domainName];
        const domainKey = cfg.key;
        const containerId = cfg.containerId;

        const domainQuestions = allQuestions.filter(q => (q.domain || '').trim() === domainName.trim());
        const shuffled = shuffle(domainQuestions);
        const selected = shuffled.slice(0, 5);

        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';

        selected.forEach((q, index) => {
          const uniqueId = domainKey + '_' + (index + 1);

          const options = getOptionsFromQuestion(q);
          const correctLetter = detectCorrectLetter(q, options);
          const correctOptionObj = options.find(o => o.letter === correctLetter) || options[0] || { text: '' };

          questionMeta[uniqueId] = {
            domainKey: domainKey,
            correctOption: correctLetter,
            correctText: correctOptionObj ? correctOptionObj.text : '',
            isCorrect: null
          };

          questionsByDomain[domainKey].push(uniqueId);

          const card = buildQuestionCard(q, uniqueId, domainKey, options);
          container.appendChild(card);
        });
      });
    }

    // Fetch JSON on load
    fetch('medai_questions.json')
      .then(resp => {
        if (!resp.ok) {
          throw new Error('Could not load medai_questions.json');
        }
        return resp.json();
      })
      .then(data => {
        if (!Array.isArray(data)) {
          throw new Error('Question bank JSON must be an array');
        }
        initializeQuiz(data);
      })
      .catch(err => {
        console.error(err);
        const summaryDiv = document.getElementById('summarySection');
        summaryDiv.innerHTML = '<p class="text-xs text-red-700">There was a problem loading the MedAI Question Bank. Check that medai_questions.json is in the same folder and uses UTF-8 encoding.</p>';
      });

    // Map score to level label
    function levelFromScore(score) {
      if (score <= 3) return 'Emerging';
      if (score <= 6) return 'Functional';
      if (score <= 8) return 'Fluent';
      return 'Strategic';
    }

    // Build recommendations
    function buildRecommendations(scores) {
      const { prompt, technical, practical, critical, workflow } = scores;
      const strengths = [];
      const growth = [];

      Object.entries(scores).forEach(([key, value]) => {
        if (value >= 7) strengths.push(key);
        if (value <= 6) growth.push(key);
      });

      const labelMap = {
        prompt: 'Prompt mastery',
        technical: 'Technical understanding',
        practical: 'Practical application ability',
        critical: 'Critical evaluation ability',
        workflow: 'Workflow design ability'
      };

      const strengthsText = strengths.length
        ? strengths.map(k => labelMap[k]).join(', ')
        : 'No area is very high yet. This is a good starting point to grow across the board.';

      const growthText = growth.length
        ? growth.map(k => labelMap[k]).join(', ')
        : 'You do not have a single clear growth area from this quick quiz. Choose one that feels most relevant to your work.';

      const suggestions = [];

      if (technical <= 6) {
        suggestions.push('Spend focused time with foundational MedAI Lexicon terms on model fundamentals, context windows, hallucinations, and training versus inference. Practice explaining them in plain language to a colleague.');
      }
      if (prompt <= 6) {
        suggestions.push('Create two or three reusable prompt templates for your real teaching or research tasks, guided by the prompt related Lexicon entries. Test them on your next two or three cases.');
      }
      if (practical <= 6) {
        suggestions.push('Select one real workflow such as feedback, email drafts, or syllabus design and deliberately integrate AI, recording what saves time and what still needs improvement.');
      }
      if (critical <= 6) {
        suggestions.push('Use the Lexicon entries on hallucinations, bias, guardrails, and data governance to design small test cases where you intentionally look for errors and bias in outputs.');
      }
      if (workflow <= 6) {
        suggestions.push('Sketch a simple AI supported workflow for your course, clinic, or research pipeline. Mark where AI acts, where humans review, and which committees or leaders need to be involved.');
      }

      if (suggestions.length === 0) {
        suggestions.push('You show strong fluency across this quiz. Consider mentoring colleagues, documenting your own AI playbook, or leading a MedAI Lexicon based session for your department.');
      }

      return { strengthsText, growthText, suggestions };
    }

    // Calculate scores from correctness
    function computeDomainScore(domainKey) {
      const ids = questionsByDomain[domainKey] || [];
      if (ids.length === 0) return 0;

      let correctCount = 0;
      ids.forEach(id => {
        const meta = questionMeta[id];
        if (meta && meta.isCorrect === true) {
          correctCount += 1;
        }
      });

      const ratio = correctCount / ids.length;
      let score = Math.round(ratio * 10);
      if (score < 0) score = 0;
      if (score > 10) score = 10;
      return score;
    }

    // Ensure all questions answered
    function allQuestionsAnswered() {
      return Object.values(questionMeta).every(m => m.isCorrect !== null);
    }

    document.getElementById('calculateBtn').addEventListener('click', () => {
      if (!allQuestionsAnswered()) {
        alert('Please answer all questions before viewing your fluency map.');
        return;
      }

      const scores = {
        prompt: computeDomainScore('prompt'),
        technical: computeDomainScore('technical'),
        practical: computeDomainScore('practical'),
        critical: computeDomainScore('critical'),
        workflow: computeDomainScore('workflow')
      };

      // Update chart
      fluencyChart.data.datasets[0].data = [
        scores.prompt,
        scores.technical,
        scores.practical,
        scores.critical,
        scores.workflow
      ];
      fluencyChart.update();

      // Update summary
      const summaryDiv = document.getElementById('summarySection');
      const { strengthsText, growthText, suggestions } = buildRecommendations(scores);

      summaryDiv.innerHTML = `
        <div>
          <h4 class="text-sm font-semibold text-slate-900">Quiz based scores by competency</h4>
          <ul class="mt-1 text-xs text-slate-700 space-y-1">
            <li>Prompt mastery: <span class="font-medium">${scores.prompt}/10</span> - ${levelFromScore(scores.prompt)}</li>
            <li>Technical understanding: <span class="font-medium">${scores.technical}/10</span> - ${levelFromScore(scores.technical)}</li>
            <li>Practical application ability: <span class="font-medium">${scores.practical}/10</span> - ${levelFromScore(scores.practical)}</li>
            <li>Critical evaluation ability: <span class="font-medium">${scores.critical}/10</span> - ${levelFromScore(scores.critical)}</li>
            <li>Workflow design ability: <span class="font-medium">${scores.workflow}/10</span> - ${levelFromScore(scores.workflow)}</li>
          </ul>
        </div>
        <div>
          <h4 class="mt-3 text-sm font-semibold text-slate-900">Strength profile</h4>
          <p class="mt-1 text-xs text-slate-700">
            <span class="font-medium">Strongest areas:</span> ${strengthsText}
          </p>
          <p class="mt-1 text-xs text-slate-700">
            <span class="font-medium">Growth focus:</span> ${growthText}
          </p>
        </div>
        <div>
          <h4 class="mt-3 text-sm font-semibold text-slate-900">Suggested learning pathway</h4>
          <ul class="mt-1 text-xs text-slate-700 list-disc pl-4 space-y-1">
            ${suggestions.map(s => `<li>${s}</li>`).join('')}
          </ul>
          <p class="mt-2 text-xs text-slate-500">
            Use the MedAI Lexicon as your reference. Start with the terms linked to your growth areas, then extend into your strengths so that you can support learners and colleagues.
          </p>
        </div>
      `;
    });
  </script>
</body>
</html>
